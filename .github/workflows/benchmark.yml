name: Benchmark Comparison

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'Cargo.toml'

jobs:
  benchmark:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Check io_uring support
        run: |
          echo "Kernel version:"
          uname -r
          echo ""
          echo "io_uring support:"
          cat /proc/kallsyms | grep -c io_uring || echo "io_uring symbols found"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Redis
        run: |
          sudo apt-get update
          sudo apt-get install -y redis-server redis-tools

      - name: Build Viator (standard)
        run: cargo build --release

      - name: Build Viator (io_uring)
        run: cargo build --release --features io-uring
        continue-on-error: true  # May fail if io_uring not fully supported

      - name: Benchmark - Viator vs Redis
        run: |
          echo "## Benchmark Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Environment:** $(uname -r) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Start Redis on port 6380
          redis-server --port 6380 --daemonize yes
          sleep 2

          # Start Viator on port 6379
          ./target/release/viator-server --port 6379 &
          VIATOR_PID=$!
          sleep 2

          echo "### Single Command Performance (100K requests, 50 clients)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Command | Viator (req/s) | Redis (req/s) | Gap |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---------|----------------|---------------|-----|" >> "$GITHUB_STEP_SUMMARY"

          # Benchmark SET
          VIATOR_SET=$(redis-benchmark -p 6379 -t set -n 100000 -c 50 -q 2>&1 | grep "SET:" | tail -1 | awk '{print $2}')
          REDIS_SET=$(redis-benchmark -p 6380 -t set -n 100000 -c 50 -q 2>&1 | grep "SET:" | tail -1 | awk '{print $2}')
          GAP_SET=$(echo "scale=1; (($VIATOR_SET - $REDIS_SET) / $REDIS_SET) * 100" | bc)
          echo "| SET | $VIATOR_SET | $REDIS_SET | ${GAP_SET}% |" >> "$GITHUB_STEP_SUMMARY"

          # Benchmark GET
          VIATOR_GET=$(redis-benchmark -p 6379 -t get -n 100000 -c 50 -q 2>&1 | grep "GET:" | tail -1 | awk '{print $2}')
          REDIS_GET=$(redis-benchmark -p 6380 -t get -n 100000 -c 50 -q 2>&1 | grep "GET:" | tail -1 | awk '{print $2}')
          GAP_GET=$(echo "scale=1; (($VIATOR_GET - $REDIS_GET) / $REDIS_GET) * 100" | bc)
          echo "| GET | $VIATOR_GET | $REDIS_GET | ${GAP_GET}% |" >> "$GITHUB_STEP_SUMMARY"

          # Benchmark PING
          VIATOR_PING=$(redis-benchmark -p 6379 -t ping -n 100000 -c 50 -q 2>&1 | grep "PING_INLINE:" | tail -1 | awk '{print $2}')
          REDIS_PING=$(redis-benchmark -p 6380 -t ping -n 100000 -c 50 -q 2>&1 | grep "PING_INLINE:" | tail -1 | awk '{print $2}')
          GAP_PING=$(echo "scale=1; (($VIATOR_PING - $REDIS_PING) / $REDIS_PING) * 100" | bc)
          echo "| PING | $VIATOR_PING | $REDIS_PING | ${GAP_PING}% |" >> "$GITHUB_STEP_SUMMARY"

          # Benchmark INCR
          VIATOR_INCR=$(redis-benchmark -p 6379 -t incr -n 100000 -c 50 -q 2>&1 | grep "INCR:" | tail -1 | awk '{print $2}')
          REDIS_INCR=$(redis-benchmark -p 6380 -t incr -n 100000 -c 50 -q 2>&1 | grep "INCR:" | tail -1 | awk '{print $2}')
          GAP_INCR=$(echo "scale=1; (($VIATOR_INCR - $REDIS_INCR) / $REDIS_INCR) * 100" | bc)
          echo "| INCR | $VIATOR_INCR | $REDIS_INCR | ${GAP_INCR}% |" >> "$GITHUB_STEP_SUMMARY"

          # Benchmark LPUSH
          VIATOR_LPUSH=$(redis-benchmark -p 6379 -t lpush -n 100000 -c 50 -q 2>&1 | grep "LPUSH:" | tail -1 | awk '{print $2}')
          REDIS_LPUSH=$(redis-benchmark -p 6380 -t lpush -n 100000 -c 50 -q 2>&1 | grep "LPUSH:" | tail -1 | awk '{print $2}')
          GAP_LPUSH=$(echo "scale=1; (($VIATOR_LPUSH - $REDIS_LPUSH) / $REDIS_LPUSH) * 100" | bc)
          echo "| LPUSH | $VIATOR_LPUSH | $REDIS_LPUSH | ${GAP_LPUSH}% |" >> "$GITHUB_STEP_SUMMARY"

          # Benchmark HSET
          VIATOR_HSET=$(redis-benchmark -p 6379 -t hset -n 100000 -c 50 -q 2>&1 | grep "HSET:" | tail -1 | awk '{print $2}')
          REDIS_HSET=$(redis-benchmark -p 6380 -t hset -n 100000 -c 50 -q 2>&1 | grep "HSET:" | tail -1 | awk '{print $2}')
          GAP_HSET=$(echo "scale=1; (($VIATOR_HSET - $REDIS_HSET) / $REDIS_HSET) * 100" | bc)
          echo "| HSET | $VIATOR_HSET | $REDIS_HSET | ${GAP_HSET}% |" >> "$GITHUB_STEP_SUMMARY"

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "*Negative gap = Viator is slower, Positive gap = Viator is faster*" >> "$GITHUB_STEP_SUMMARY"

          # Cleanup
          kill $VIATOR_PID 2>/dev/null || true
          redis-cli -p 6380 shutdown nosave 2>/dev/null || true

      - name: High Concurrency Benchmark
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### High Concurrency (100K requests, 200 clients)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Command | Viator (req/s) | Redis (req/s) | Gap |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---------|----------------|---------------|-----|" >> "$GITHUB_STEP_SUMMARY"

          # Start servers again
          redis-server --port 6380 --daemonize yes
          sleep 1
          ./target/release/viator-server --port 6379 &
          VIATOR_PID=$!
          sleep 2

          # SET with 200 clients
          VIATOR_SET=$(redis-benchmark -p 6379 -t set -n 100000 -c 200 -q 2>&1 | grep "SET:" | tail -1 | awk '{print $2}')
          REDIS_SET=$(redis-benchmark -p 6380 -t set -n 100000 -c 200 -q 2>&1 | grep "SET:" | tail -1 | awk '{print $2}')
          GAP=$(echo "scale=1; (($VIATOR_SET - $REDIS_SET) / $REDIS_SET) * 100" | bc)
          echo "| SET | $VIATOR_SET | $REDIS_SET | ${GAP}% |" >> "$GITHUB_STEP_SUMMARY"

          # GET with 200 clients
          VIATOR_GET=$(redis-benchmark -p 6379 -t get -n 100000 -c 200 -q 2>&1 | grep "GET:" | tail -1 | awk '{print $2}')
          REDIS_GET=$(redis-benchmark -p 6380 -t get -n 100000 -c 200 -q 2>&1 | grep "GET:" | tail -1 | awk '{print $2}')
          GAP=$(echo "scale=1; (($VIATOR_GET - $REDIS_GET) / $REDIS_GET) * 100" | bc)
          echo "| GET | $VIATOR_GET | $REDIS_GET | ${GAP}% |" >> "$GITHUB_STEP_SUMMARY"

          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Cleanup
          kill $VIATOR_PID 2>/dev/null || true
          redis-cli -p 6380 shutdown nosave 2>/dev/null || true

      - name: Pipeline Benchmark
        run: |
          echo "### Pipeline Performance (16 commands per pipeline)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Command | Viator (req/s) | Redis (req/s) | Gap |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---------|----------------|---------------|-----|" >> "$GITHUB_STEP_SUMMARY"

          # Start servers again
          redis-server --port 6380 --daemonize yes
          sleep 1
          ./target/release/viator-server --port 6379 &
          VIATOR_PID=$!
          sleep 2

          # SET with pipeline
          VIATOR_SET=$(redis-benchmark -p 6379 -t set -n 100000 -c 50 -P 16 -q 2>&1 | grep "SET:" | tail -1 | awk '{print $2}')
          REDIS_SET=$(redis-benchmark -p 6380 -t set -n 100000 -c 50 -P 16 -q 2>&1 | grep "SET:" | tail -1 | awk '{print $2}')
          GAP=$(echo "scale=1; (($VIATOR_SET - $REDIS_SET) / $REDIS_SET) * 100" | bc)
          echo "| SET (pipeline) | $VIATOR_SET | $REDIS_SET | ${GAP}% |" >> "$GITHUB_STEP_SUMMARY"

          # GET with pipeline
          VIATOR_GET=$(redis-benchmark -p 6379 -t get -n 100000 -c 50 -P 16 -q 2>&1 | grep "GET:" | tail -1 | awk '{print $2}')
          REDIS_GET=$(redis-benchmark -p 6380 -t get -n 100000 -c 50 -P 16 -q 2>&1 | grep "GET:" | tail -1 | awk '{print $2}')
          GAP=$(echo "scale=1; (($VIATOR_GET - $REDIS_GET) / $REDIS_GET) * 100" | bc)
          echo "| GET (pipeline) | $VIATOR_GET | $REDIS_GET | ${GAP}% |" >> "$GITHUB_STEP_SUMMARY"

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "*Benchmarked with redis-benchmark on GitHub Actions Ubuntu runner*" >> "$GITHUB_STEP_SUMMARY"

          # Cleanup
          kill $VIATOR_PID 2>/dev/null || true
          redis-cli -p 6380 shutdown nosave 2>/dev/null || true
