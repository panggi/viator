name: Benchmark Comparison

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'Cargo.toml'

permissions:
  contents: read

jobs:
  benchmark:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Check io_uring support
        run: |
          echo "Kernel version:"
          uname -r
          echo ""
          echo "io_uring support:"
          cat /proc/kallsyms | grep -c io_uring || echo "io_uring symbols found"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Redis
        run: |
          sudo apt-get update
          sudo apt-get install -y redis-tools
          # Download and build Redis from source to avoid systemd service
          wget https://download.redis.io/redis-stable.tar.gz
          tar xzf redis-stable.tar.gz
          cd redis-stable && make -j$(nproc)
          sudo cp src/redis-server /usr/local/bin/

      - name: Build Viator
        run: cargo build --release

      - name: Benchmark - Viator vs Redis
        run: |
          echo "## Benchmark Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Environment:** $(uname -r) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Make sure no servers are running
          pkill -9 redis-server || true
          pkill -9 viator-server || true
          sleep 1

          # Fix Redis memory warning
          sudo sysctl vm.overcommit_memory=1 || true

          # Start Redis on port 6380
          /usr/local/bin/redis-server --port 6380 --daemonize yes --loglevel warning
          sleep 2

          # Start Viator on port 6379
          ./target/release/viator-server --port 6379 &
          VIATOR_PID=$!
          sleep 2

          # Verify both servers are running
          redis-cli -p 6379 PING || { echo "Viator not responding"; exit 1; }
          redis-cli -p 6380 PING || { echo "Redis not responding"; exit 1; }

          echo "### Single Command Performance (100K requests, 50 clients)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Command | Viator (req/s) | Redis (req/s) | Gap |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---------|----------------|---------------|-----|" >> "$GITHUB_STEP_SUMMARY"

          # Function to extract requests per second from redis-benchmark output
          # Output format: "SET: 123456.78 requests per second, p50=0.271 msec"
          extract_rps() {
            tr '\r' '\n' | grep "requests per second" | tail -1 | awk '{print $2}'
          }

          # Function to safely calculate gap percentage
          calc_gap() {
            local v=$1 r=$2
            if [ -z "$v" ] || [ -z "$r" ] || [ "$r" = "0" ] || [ "$v" = "0" ]; then
              echo "N/A"
            else
              echo "scale=1; (($v - $r) / $r) * 100" | bc 2>/dev/null || echo "N/A"
            fi
          }

          # Benchmark SET
          VIATOR_SET=$(redis-benchmark -p 6379 -t set -n 100000 -c 50 -q 2>&1 | extract_rps)
          REDIS_SET=$(redis-benchmark -p 6380 -t set -n 100000 -c 50 -q 2>&1 | extract_rps)
          GAP_SET=$(calc_gap "$VIATOR_SET" "$REDIS_SET")
          echo "| SET | ${VIATOR_SET:-N/A} | ${REDIS_SET:-N/A} | ${GAP_SET}% |" >> "$GITHUB_STEP_SUMMARY"

          # Benchmark GET
          VIATOR_GET=$(redis-benchmark -p 6379 -t get -n 100000 -c 50 -q 2>&1 | extract_rps)
          REDIS_GET=$(redis-benchmark -p 6380 -t get -n 100000 -c 50 -q 2>&1 | extract_rps)
          GAP_GET=$(calc_gap "$VIATOR_GET" "$REDIS_GET")
          echo "| GET | ${VIATOR_GET:-N/A} | ${REDIS_GET:-N/A} | ${GAP_GET}% |" >> "$GITHUB_STEP_SUMMARY"

          # Benchmark PING
          VIATOR_PING=$(redis-benchmark -p 6379 -t ping -n 100000 -c 50 -q 2>&1 | grep "PING_INLINE" | extract_rps)
          REDIS_PING=$(redis-benchmark -p 6380 -t ping -n 100000 -c 50 -q 2>&1 | grep "PING_INLINE" | extract_rps)
          GAP_PING=$(calc_gap "$VIATOR_PING" "$REDIS_PING")
          echo "| PING | ${VIATOR_PING:-N/A} | ${REDIS_PING:-N/A} | ${GAP_PING}% |" >> "$GITHUB_STEP_SUMMARY"

          # Benchmark INCR
          VIATOR_INCR=$(redis-benchmark -p 6379 -t incr -n 100000 -c 50 -q 2>&1 | extract_rps)
          REDIS_INCR=$(redis-benchmark -p 6380 -t incr -n 100000 -c 50 -q 2>&1 | extract_rps)
          GAP_INCR=$(calc_gap "$VIATOR_INCR" "$REDIS_INCR")
          echo "| INCR | ${VIATOR_INCR:-N/A} | ${REDIS_INCR:-N/A} | ${GAP_INCR}% |" >> "$GITHUB_STEP_SUMMARY"

          # Benchmark LPUSH
          VIATOR_LPUSH=$(redis-benchmark -p 6379 -t lpush -n 100000 -c 50 -q 2>&1 | extract_rps)
          REDIS_LPUSH=$(redis-benchmark -p 6380 -t lpush -n 100000 -c 50 -q 2>&1 | extract_rps)
          GAP_LPUSH=$(calc_gap "$VIATOR_LPUSH" "$REDIS_LPUSH")
          echo "| LPUSH | ${VIATOR_LPUSH:-N/A} | ${REDIS_LPUSH:-N/A} | ${GAP_LPUSH}% |" >> "$GITHUB_STEP_SUMMARY"

          # Benchmark HSET
          VIATOR_HSET=$(redis-benchmark -p 6379 -t hset -n 100000 -c 50 -q 2>&1 | extract_rps)
          REDIS_HSET=$(redis-benchmark -p 6380 -t hset -n 100000 -c 50 -q 2>&1 | extract_rps)
          GAP_HSET=$(calc_gap "$VIATOR_HSET" "$REDIS_HSET")
          echo "| HSET | ${VIATOR_HSET:-N/A} | ${REDIS_HSET:-N/A} | ${GAP_HSET}% |" >> "$GITHUB_STEP_SUMMARY"

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "*Negative gap = Viator is slower, Positive gap = Viator is faster*" >> "$GITHUB_STEP_SUMMARY"

          # Cleanup
          kill $VIATOR_PID 2>/dev/null || true
          redis-cli -p 6380 shutdown nosave 2>/dev/null || true

      - name: High Concurrency Benchmark
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### High Concurrency (100K requests, 200 clients)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Command | Viator (req/s) | Redis (req/s) | Gap |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---------|----------------|---------------|-----|" >> "$GITHUB_STEP_SUMMARY"

          extract_rps() {
            tr '\r' '\n' | grep "requests per second" | tail -1 | awk '{print $2}'
          }

          calc_gap() {
            local v=$1 r=$2
            if [ -z "$v" ] || [ -z "$r" ] || [ "$r" = "0" ] || [ "$v" = "0" ]; then
              echo "N/A"
            else
              echo "scale=1; (($v - $r) / $r) * 100" | bc 2>/dev/null || echo "N/A"
            fi
          }

          # Start servers again
          /usr/local/bin/redis-server --port 6380 --daemonize yes --loglevel warning
          sleep 1
          ./target/release/viator-server --port 6379 &
          VIATOR_PID=$!
          sleep 2

          # SET with 200 clients
          VIATOR_SET=$(redis-benchmark -p 6379 -t set -n 100000 -c 200 -q 2>&1 | extract_rps)
          REDIS_SET=$(redis-benchmark -p 6380 -t set -n 100000 -c 200 -q 2>&1 | extract_rps)
          GAP=$(calc_gap "$VIATOR_SET" "$REDIS_SET")
          echo "| SET | ${VIATOR_SET:-N/A} | ${REDIS_SET:-N/A} | ${GAP}% |" >> "$GITHUB_STEP_SUMMARY"

          # GET with 200 clients
          VIATOR_GET=$(redis-benchmark -p 6379 -t get -n 100000 -c 200 -q 2>&1 | extract_rps)
          REDIS_GET=$(redis-benchmark -p 6380 -t get -n 100000 -c 200 -q 2>&1 | extract_rps)
          GAP=$(calc_gap "$VIATOR_GET" "$REDIS_GET")
          echo "| GET | ${VIATOR_GET:-N/A} | ${REDIS_GET:-N/A} | ${GAP}% |" >> "$GITHUB_STEP_SUMMARY"

          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Cleanup
          kill $VIATOR_PID 2>/dev/null || true
          redis-cli -p 6380 shutdown nosave 2>/dev/null || true

      - name: Pipeline Benchmark
        run: |
          echo "### Pipeline Performance (16 commands per pipeline)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Command | Viator (req/s) | Redis (req/s) | Gap |" >> "$GITHUB_STEP_SUMMARY"
          echo "|---------|----------------|---------------|-----|" >> "$GITHUB_STEP_SUMMARY"

          extract_rps() {
            tr '\r' '\n' | grep "requests per second" | tail -1 | awk '{print $2}'
          }

          calc_gap() {
            local v=$1 r=$2
            if [ -z "$v" ] || [ -z "$r" ] || [ "$r" = "0" ] || [ "$v" = "0" ]; then
              echo "N/A"
            else
              echo "scale=1; (($v - $r) / $r) * 100" | bc 2>/dev/null || echo "N/A"
            fi
          }

          # Start servers again
          /usr/local/bin/redis-server --port 6380 --daemonize yes --loglevel warning
          sleep 1
          ./target/release/viator-server --port 6379 &
          VIATOR_PID=$!
          sleep 2

          # SET with pipeline
          VIATOR_SET=$(redis-benchmark -p 6379 -t set -n 100000 -c 50 -P 16 -q 2>&1 | extract_rps)
          REDIS_SET=$(redis-benchmark -p 6380 -t set -n 100000 -c 50 -P 16 -q 2>&1 | extract_rps)
          GAP=$(calc_gap "$VIATOR_SET" "$REDIS_SET")
          echo "| SET (pipeline) | ${VIATOR_SET:-N/A} | ${REDIS_SET:-N/A} | ${GAP}% |" >> "$GITHUB_STEP_SUMMARY"

          # GET with pipeline
          VIATOR_GET=$(redis-benchmark -p 6379 -t get -n 100000 -c 50 -P 16 -q 2>&1 | extract_rps)
          REDIS_GET=$(redis-benchmark -p 6380 -t get -n 100000 -c 50 -P 16 -q 2>&1 | extract_rps)
          GAP=$(calc_gap "$VIATOR_GET" "$REDIS_GET")
          echo "| GET (pipeline) | ${VIATOR_GET:-N/A} | ${REDIS_GET:-N/A} | ${GAP}% |" >> "$GITHUB_STEP_SUMMARY"

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "*Benchmarked with redis-benchmark on GitHub Actions Ubuntu runner*" >> "$GITHUB_STEP_SUMMARY"

          # Cleanup
          kill $VIATOR_PID 2>/dev/null || true
          redis-cli -p 6380 shutdown nosave 2>/dev/null || true
